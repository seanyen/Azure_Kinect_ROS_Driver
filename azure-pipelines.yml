# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

name: Azure_Kinect_ROS_Driver-$(SourceBranchName)-$(Date:yyyyMMdd)-$(Rev:rrr)

trigger:
  batch: true
  branches:
    include:
    - master
    - develop
    - melodic
    - seanyen/conda

pr:
  autoCancel: true
  branches:
    include: 
    - master
    - develop
    - melodic

jobs:
- job: WindowsNoetic
  displayName: Windows Noetic

  pool:
    vmImage: 'windows-2019'

  steps:
  - task: Cache@2
    inputs:
      key: mykey | mylockfile
      restoreKeys: mykey
      path: $(Pipeline.Workspace)
      cacheHitVar: CACHE_RESTORED

  - checkout: self
    clean: "all"
    fetchDepth: 20
    lfs: false
    persistCredentials: true
    submodules: true
    path: src\Azure_Kinect_ROS_Driver

  - powershell: Write-Host "##vso[task.prependpath]$env:CONDA\Scripts"
    displayName: Add conda to PATH

  # Download and install the Azure Kinect Sensor SDK 
  - powershell: |
      wget http://download.microsoft.com/download/1/9/8/198048e8-63f2-45c6-8f96-1fd541d1b4bc/Azure%20Kinect%20SDK%201.2.0.msi -OutFile $(Build.SourcesDirectory)\sdk.msi
      $(Build.SourcesDirectory)\sdk.msi /passive

  - script: |
      set CC=cl.exe
      set CXX=cl.exe
      set Boost_ROOT=
      set BOOST_ROOT_1_69_0=
      set BOOST_ROOT_1_72_0=
      set PATH=%PATH:C:\hostedtoolcache\windows\Boost\1.72.0;=%
      set ROS_PYTHON_VERSION=3
      pushd %PIPELINE_WORKSPACE%
      conda env create --prefix ./colcon -f src\Azure_Kinect_ROS_Driver\environment.yaml
      call activate ./colcon
      mkdir src\deps
      vcs import .\src\deps < src\Azure_Kinect_ROS_Driver\deps.rosinstall
      pushd .\src\deps\catkin
      echo catkin path
      git apply %PIPELINE_WORKSPACE%\src\Azure_Kinect_ROS_Driver\catkin.patch
      popd
      pushd .\src\deps\vision_opencv
      echo vision_opencv path
      git apply %PIPELINE_WORKSPACE%\src\Azure_Kinect_ROS_Driver\vision_opencv.patch
      popd
      set "COLCON_HOME=%PIPELINE_WORKSPACE%\src\Azure_Kinect_ROS_Driver"
      call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
      colcon build --packages-up-to azure_kinect_ros_driver
    displayName: Cache build
    condition: ne(variables.CACHE_RESTORED, 'true')

  - script: |
      set CC=cl.exe
      set CXX=cl.exe
      set Boost_ROOT=
      set BOOST_ROOT_1_69_0=
      set BOOST_ROOT_1_72_0=
      set PATH=%PATH:C:\hostedtoolcache\windows\Boost\1.72.0;=%
      set ROS_PYTHON_VERSION=3
      set "COLCON_HOME=%PIPELINE_WORKSPACE%\src\Azure_Kinect_ROS_Driver"
      call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
      colcon build --packages-up-to azure_kinect_ros_driver
    displayName: CI build

- job: LinuxMelodic
  displayName: Linux Melodic

  pool:
    vmImage: 'ubuntu-16.04'

  container: 
    image: ros:melodic-perception-bionic
    options: "--name ci-container -v /usr/bin/docker:/tmp/docker:ro"

  steps:
  - script: |
      /tmp/docker exec -t -u 0 ci-container \
      sh -c "apt-get update && DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confold" -y install sudo"
    displayName: Enable sudo

  - checkout: self
    clean: "all"
    fetchDepth: 20
    lfs: false
    persistCredentials: true
    submodules: true
    path: catkin_ws/src/Azure_Kinect_ROS_Driver

  # Download and install the Azure Kinect Sensor SDK 
  - bash: |
      sudo apt-get -y install curl software-properties-common
      curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
      sudo apt-add-repository https://packages.microsoft.com/ubuntu/18.04/prod
      sudo apt-get update
      echo libk4a1.2 libk4a1.2/accept-eula boolean true | sudo debconf-set-selections
      echo libk4a1.2 libk4a1.2/accepted-eula-hash string 0f5d5c5de396e4fee4c0753a21fee0c1ed726cf0316204edda484f08cb266d76 | sudo debconf-set-selections -u
      sudo apt-get -y install libk4a1.2-dev
    displayName: Install the Azure Kinect Sensor SDK

  # Build the catkin workspace
  - bash: |
      source /opt/ros/melodic/setup.bash
      catkin_make --force-cmake
    displayName: Build ROS Driver Node
    workingDirectory: ../../
